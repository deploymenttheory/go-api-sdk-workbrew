package acceptance

import (
	"testing"

	"github.com/deploymenttheory/go-api-sdk-workbrew/workbrew/services/vulnerabilitychanges"
	"github.com/stretchr/testify/assert"
)

// TestAcceptance_VulnerabilityChanges_ListVulnerabilityChanges tests retrieving vulnerability changes in JSON format
func TestAcceptance_VulnerabilityChanges_ListVulnerabilityChanges(t *testing.T) {
	RequireClient(t)

	RateLimitedTest(t, func(t *testing.T) {
		ctx, cancel := NewContext()
		defer cancel()

		service := vulnerabilitychanges.NewService(Client)

		LogTestStage(t, "ðŸ“Š List Vulnerability Changes", "Testing ListVulnerabilityChanges")

		result, resp, err := service.ListVulnerabilityChanges(ctx, nil)
		AssertNoError(t, err, "ListVulnerabilityChanges should not return an error")
		AssertNotNil(t, result, "ListVulnerabilityChanges result should not be nil")
		AssertNotNil(t, resp, "Response should not be nil")
		assert.Equal(t, 200, resp.StatusCode, "Status code should be 200")

		// Validate response structure
		assert.NotNil(t, result, "Vulnerability changes list should not be nil")

		changeCount := len(*result)
		LogTestSuccess(t, "Retrieved %d vulnerability changes", changeCount)

		// If changes exist, validate structure
		if changeCount > 0 {
			change := (*result)[0]
			assert.NotEmpty(t, change.VulnerabilityID, "VulnerabilityID should not be empty")

			deviceSerial := "N/A"
			if change.DeviceSerialNumber != nil {
				deviceSerial = *change.DeviceSerialNumber
			}

			LogResponse(t, "  Sample change - VulnID: %s, Device: %s, Status: %s, OccurredAt: %v",
				change.VulnerabilityID,
				deviceSerial,
				change.Status,
				change.OccurredAt)
		}
	})
}

// TestAcceptance_VulnerabilityChanges_ListVulnerabilityChangesCSV tests retrieving vulnerability changes in CSV format
func TestAcceptance_VulnerabilityChanges_ListVulnerabilityChangesCSV(t *testing.T) {
	RequireClient(t)

	RateLimitedTest(t, func(t *testing.T) {
		ctx, cancel := NewContext()
		defer cancel()

		service := vulnerabilitychanges.NewService(Client)

		LogTestStage(t, "ðŸ“Š List Vulnerability Changes CSV", "Testing ListVulnerabilityChangesCSV")

		csvData, resp, err := service.ListVulnerabilityChangesCSV(ctx, nil)
		AssertNoError(t, err, "ListVulnerabilityChangesCSV should not return an error")
		AssertNotNil(t, csvData, "CSV data should not be nil")
		AssertNotNil(t, resp, "Response should not be nil")
		assert.Equal(t, 200, resp.StatusCode, "Status code should be 200")

		// Validate CSV data
		assert.Greater(t, len(csvData), 0, "CSV data should not be empty")

		// CSV should start with headers
		csvString := string(csvData)
		assert.Contains(t, csvString, "cve", "CSV should contain cve header")

		LogTestSuccess(t, "Retrieved CSV data with %d bytes", len(csvData))
		LogResponse(t, "  CSV preview: %s", csvString[:min(100, len(csvString))])
	})
}
